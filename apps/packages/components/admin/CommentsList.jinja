{#def request, user, comments=[], show_deleted=False #}
{#import "../layouts/Admin.jinja" as AdminLayout #}
{#import "../ui/Button.jinja" as Button #}
{#import "../ui/Badge.jinja" as Badge #}
{#import "../ui/EmptyState.jinja" as EmptyState #}

<AdminLayout request={{ request }} user={{ user }} title="Comments" current_page="comments">
    <div class="space-y-6">
        <header class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-white mb-1">Comments</h1>
                <p class="text-sm text-gray-400">Moderate comments across all blog posts.</p>
            </div>
            <a 
                href="/admin/comments{{ '?show_deleted=true' if not show_deleted else '' }}"
                class="text-sm text-gray-400 hover:text-white transition-colors"
            >
                {{ 'Show Active Only' if show_deleted else 'Show Deleted' }}
            </a>
        </header>

        {% if comments %}
        <div class="bg-gray-900/50 rounded-lg border border-gray-800 overflow-hidden">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-gray-400 text-left border-b border-gray-800">
                        <th class="px-4 py-3 font-medium">Author</th>
                        <th class="px-4 py-3 font-medium">Comment</th>
                        <th class="px-4 py-3 font-medium">Post</th>
                        <th class="px-4 py-3 font-medium">Date</th>
                        <th class="px-4 py-3 font-medium text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800">
                    {% for comment in comments %}
                    <tr 
                        class="text-gray-300 hover:bg-gray-800/50 cursor-pointer {{ 'opacity-50' if comment.is_deleted else '' }}"
                        hx-get="/admin/comments/{{ comment.id }}"
                        hx-trigger="click"
                        hx-target="#comment-modal-container"
                        hx-swap="innerHTML"
                        hx-indicator="#comment-loading"
                        onclick="const modal=document.getElementById('comment-modal'); if(modal){modal.classList.remove('hidden'); modal.classList.add('flex');}"
                    >
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-white">{{ comment.display_name }}</span>
                                {% if comment.is_guest %}
                                <Badge text="Guest" color="gray" size="sm" />
                                {% endif %}
                            </div>
                            {% if comment.ip_address %}
                            <div class="text-[10px] text-gray-500 mt-0.5">{{ comment.ip_address }}</div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <div class="max-w-xs truncate" title="{{ comment.content }}">
                                {{ comment.content[:100] }}{{ '...' if comment.content | length > 100 else '' }}
                            </div>
                            {% if comment.is_deleted %}
                            <Badge text="Deleted" color="red" size="sm" />
                            {% endif %}
                            {% if comment.is_flagged %}
                            <Badge text="Flagged" color="yellow" size="sm" />
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <a href="{{ PUBLIC_BLOG_URL }}/posts/{{ comment.post_slug }}" class="text-accent hover:underline" target="_blank" onclick="event.stopPropagation();">
                                {{ comment.post_title[:30] }}{{ '...' if comment.post_title | length > 30 else '' }}
                            </a>
                        </td>
                        <td class="px-4 py-3 text-gray-500 text-xs">
                            {{ comment.created_at.strftime('%d/%m/%Y %H:%M') if comment.created_at else '-' }}
                        </td>
                        <td class="px-4 py-3 text-right" onclick="event.stopPropagation();">
                            {% if comment.is_deleted %}
                            <form action="/admin/comments/{{ comment.id }}/restore" method="POST" class="inline">
                                <button type="submit" class="text-green-500 hover:text-green-400 text-xs">
                                    Restore
                                </button>
                            </form>
                            {% else %}
                            <form action="/admin/comments/{{ comment.id }}/delete" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this comment?')">
                                <button type="submit" class="text-red-500 hover:text-red-400 text-xs">
                                    Delete
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <EmptyState message="No comments found" />
        {% endif %}
    </div>
    
    {# Modal Container #}
    <div 
        id="comment-modal" 
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
        onclick="if(event.target === this) { this.classList.add('hidden'); this.classList.remove('flex'); }"
    >
        <div id="comment-modal-container" class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
            {# Content loaded via HTMX #}
            <div id="comment-loading" class="p-6 text-gray-400 text-center htmx-indicator">Loading...</div>
            <div class="p-6 text-gray-400 text-center">Select a comment to view details.</div>
        </div>
    </div>
</AdminLayout>
