{#def request, user, settings #}
{#import "../layouts/Admin.jinja" as AdminLayout #}
{#import "../ui/Input.jinja" as Input #}
{#import "../ui/Button.jinja" as Button #}

<AdminLayout request={{ request }} user={{ user }} title="Settings" current_page="settings">
    <div class="space-y-8">
        <header>
            <h1 class="text-2xl font-bold text-white mb-1">Settings</h1>
            <p class="text-sm text-gray-400">Configure site-wide settings and integrations.</p>
        </header>

        <form action="/admin/settings" method="POST" class="space-y-8">
            {# General Settings #}
            <section class="bg-gray-900/50 rounded-lg border border-gray-800 p-6">
                <h2 class="text-lg font-semibold text-white mb-4">General</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Input 
                        name="site_name" 
                        label="Site Name" 
                        value={{ settings.site_name or "Portfolio" }}
                    />
                    <Input 
                        name="site_description" 
                        label="Site Description" 
                        value={{ settings.site_description or "" }}
                    />
                </div>
            </section>

            {# Page Visibility #}
            <section class="bg-gray-900/50 rounded-lg border border-gray-800 p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Page Visibility</h2>
                <p class="text-sm text-gray-400 mb-4">Enable or disable sections of your portfolio.</p>
                <div class="flex flex-wrap gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input 
                            type="checkbox" 
                            name="projects_enabled"
                            {{ 'checked' if settings.projects_enabled else '' }}
                            class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-accent focus:ring-accent"
                        />
                        <span class="text-sm text-gray-300">Projects Page</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input 
                            type="checkbox" 
                            name="blog_enabled"
                            {{ 'checked' if settings.blog_enabled else '' }}
                            class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-accent focus:ring-accent"
                        />
                        <span class="text-sm text-gray-300">Blog Page</span>
                    </label>
                </div>
            </section>

            {# Home Background #}
            <section class="bg-gray-900/50 rounded-lg border border-gray-800 p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Home Background</h2>
                <Input 
                    name="home_background_url" 
                    label="Background Image URL" 
                    placeholder="https://example.com/image.jpg"
                    value={{ settings.home_background_url or "" }}
                    hint="Leave empty for default dark gradient"
                />
                {% if settings.home_background_url %}
                <div class="mt-4">
                    <p class="text-xs text-gray-500 mb-2">Preview:</p>
                    <img 
                        src="{{ settings.home_background_url }}" 
                        alt="Background preview" 
                        class="max-w-xs rounded-lg border border-gray-700"
                    />
                </div>
                {% endif %}
            </section>

            {# Home Cards #}
            <section class="bg-gray-900/50 rounded-lg border border-gray-800 p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Home Cards</h2>
                <p class="text-sm text-gray-400 mb-4">Control how many cards appear on the home screen.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Input 
                        name="home_projects_count" 
                        type="number"
                        min="3"
                        max="6"
                        label="Projects cards"
                        value={{ settings.home_projects_count or 4 }}
                        hint="Minimum 3, maximum 6"
                    />
                    <Input 
                        name="home_posts_count" 
                        type="number"
                        min="3"
                        max="6"
                        label="Blog cards"
                        value={{ settings.home_posts_count or 4 }}
                        hint="Minimum 3, maximum 6"
                    />
                </div>
                <div class="mt-6">
                    <label for="home_projects_mode" class="block text-sm font-medium text-gray-300 mb-2">Projects source mode</label>
                    <select
                        id="home_projects_mode"
                        name="home_projects_mode"
                        class="w-full rounded-md bg-gray-900 border border-gray-700 text-white px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent/30 focus:border-accent"
                    >
                        <option value="featured_fallback" {{ '' if settings.home_projects_featured_only else 'selected' }}>
                            Featured + automatic fallback
                        </option>
                        <option value="featured_only" {{ 'selected' if settings.home_projects_featured_only else '' }}>
                            Only featured projects
                        </option>
                    </select>
                    <p class="mt-2 text-xs text-gray-500">
                        Use fallback to fill the configured number of cards when featured projects are fewer.
                    </p>
                </div>
            </section>

            {# GitHub Integration #}
            <section class="bg-gray-900/50 rounded-lg border border-gray-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-white">GitHub Blog Integration</h2>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input 
                            type="checkbox" 
                            name="github_enabled"
                            {{ 'checked' if settings.github_enabled else '' }}
                            class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-accent focus:ring-accent"
                        />
                        <span class="text-sm text-gray-300">Enable</span>
                    </label>
                </div>
                
                <p class="text-sm text-gray-400 mb-4">
                    Sync blog posts from a GitHub repository. Posts should be Markdown files with YAML frontmatter.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Input 
                        name="github_repo_owner" 
                        label="Repository Owner" 
                        placeholder="username or organization"
                        value={{ settings.github_repo_owner or "" }}
                    />
                    <Input 
                        name="github_repo_name" 
                        label="Repository Name" 
                        placeholder="my-blog-posts"
                        value={{ settings.github_repo_name or "" }}
                    />
                    <Input 
                        name="github_posts_path" 
                        label="Posts Path" 
                        placeholder="posts"
                        value={{ settings.github_posts_path or "posts" }}
                        hint="Path to markdown files in the repo"
                    />
                    <Input 
                        name="github_token" 
                        label="GitHub Token (optional)" 
                        type="password"
                        placeholder="ghp_xxxxxxxxxxxx"
                        value={{ "***hidden***" if settings.github_token else "" }}
                        hint="Personal access token for private repos"
                    />
                </div>
            </section>

            {# Actions #}
            <div class="flex gap-3">
                <Button type="submit" variant="primary">Save Settings</Button>
            </div>
        </form>

        {# GitHub Sync #}
        {% if settings.github_enabled and settings.github_repo_owner and settings.github_repo_name %}
        <section class="bg-gray-900/50 rounded-lg border border-gray-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Sync from GitHub</h2>
            <p class="text-sm text-gray-400 mb-4">
                Pull posts from <strong class="text-white">{{ settings.github_repo_owner }}/{{ settings.github_repo_name }}</strong>
            </p>
            <form action="/admin/settings/sync-github" method="POST">
                <Button type="submit" variant="outline">
                    Sync Posts Now
                </Button>
            </form>
        </section>
        {% endif %}

        {# Last Updated #}
        {% if settings.updated_at %}
        <p class="text-xs text-gray-500">
            Last updated: {{ settings.updated_at.strftime('%d/%m/%Y %H:%M') }}
        </p>
        {% endif %}
    </div>
</AdminLayout>
