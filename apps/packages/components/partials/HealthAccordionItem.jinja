{#import "@ui/ui/StatusDot.jinja" as StatusDot #}
{#import "@ui/ui/Badge.jinja" as Badge #}
{#def service=None #}

<div
  class="px-4 py-3"
  x-data="{
    open: false,
    logs: '',
    es: null,
    connect() {
      if (this.es) return;
      this.es = new EventSource('/healthz/logs/stream?service_id={{ service.id }}');
      this.es.onmessage = (e) => { this.logs = e.data + '\n' + this.logs; };
      this.es.onerror = () => { this.disconnect(); };
    },
    disconnect() {
      if (this.es) { this.es.close(); this.es = null; }
    },
    toggle() {
      this.open = !this.open;
      if (this.open) { this.connect(); }
      else { this.disconnect(); this.logs = ''; }
    }
  }"
  @htmx:before-swap.window="disconnect()"
>
  <button
    type="button"
    class="flex w-full items-center justify-between gap-4 rounded-md py-1 transition hover:bg-zinc-50 dark:hover:bg-zinc-900/50"
    @click="toggle()"
    :aria-expanded="open"
  >
    <div class="flex min-w-0 items-center gap-3">
      <StatusDot ok={{ service.ok }} />
      <div class="flex flex-col text-left">
        <span class="text-sm font-medium text-zinc-900 dark:text-zinc-100">{{ service.name }}</span>
        <span class="text-xs text-zinc-500 dark:text-zinc-400">{{ service.url }}</span>
      </div>
    </div>

    <div class="flex items-center gap-2 text-sm">
      {% if service.ok %}
        <Badge tone="success">OK</Badge>
      {% else %}
        <Badge tone="danger">DOWN</Badge>
      {% endif %}
      <span class="hidden text-xs text-zinc-500 sm:inline">{{ service.code }}</span>
      <span class="hidden text-xs text-zinc-400 md:inline">{{ service.datetime or "" }}</span>
      <svg
        class="h-4 w-4 text-zinc-400 transition-transform"
        :class="{ 'rotate-180': open }"
        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    </div>
  </button>

  <div
    x-show="open"
    x-transition:enter="transition ease-out duration-150"
    x-transition:enter-start="opacity-0 -translate-y-1"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-100"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="mt-3"
  >
    <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-3 dark:border-zinc-800 dark:bg-zinc-900">
      <div class="mb-2 flex items-center justify-between">
        <span class="text-xs font-medium text-zinc-500 dark:text-zinc-400">Logs</span>
        <span class="text-xs text-emerald-500" x-show="es">streaming</span>
      </div>
      <pre
        class="h-40 overflow-auto rounded-md border border-zinc-200 bg-white p-3 font-mono text-xs leading-relaxed text-zinc-700 dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-300"
        x-text="logs || 'Connecting...'"
      ></pre>
    </div>
  </div>
</div>
